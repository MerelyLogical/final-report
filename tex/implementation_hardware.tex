\chapter{Hardware Implementation}

\section{Randomiser}

\begin{figure}[H]
  \centering
  \input{illu/randomiser_block}
  \caption{Randomiser Block Diagram}
  \label{RandomiserBlk}
\end{figure}

Implementing the randomiser is straight forward.
A possible set of taps for a 32-bit Galois LFSR is [32, 30, 26, 25].
Referring back at Figure~\ref{GalLFSR} on page~\pageref{GalLFSR},
the logic is to XOR the bits left of the taps with bit 0, and simple right shift for all other bits.
For driver to control the randomiser, an enable signal and an initial signal is added as input in addition to clock and reset.
The initial signal seeds the LFSR.

\section{Driver}

\begin{figure}[H]
  \centering
  \input{illu/driver_block}
  \caption{Driver Block Diagram}
  \label{DriverBlk}
\end{figure}

The filter select signal \texttt{f\_select} selects the mode of operation of the driver.
When it is set, the driver will read from \texttt{f\_manual} and feed them to the output.
Otherwise, the driver will take the output of the randomisers at \texttt{rand\_*}, set and clearing specific bits according to \texttt{f\_bitset} and \texttt{f\_bitclr}.

The output is immediately sent to the DUT from the ports \texttt{drive\_dut\_*}.
The output is also delayed for a number of cycles before being sent to the monitor from the ports \texttt{drive\_mon\_*}.
This delay is known and thus can be configured by the user before compiling the testbench.

\begin{figure}[H]
  \centering
  \input{illu/driver_wave}
  \caption{Driver Waveform}
  \label{DriveWave}
\end{figure}

Figure \ref{DriveWave} shows how the waveform of the implemented driver looks like when operating in auto mode.
It should be stated that all waveforms in this report has been obtained from simulation, and are verified to be correct.
For clarity, unnecessary signals and signal values are omitted.

In Figure \ref{DriveWave}, we assume the design is a simple 1 input 1 output module where the input is passed to the output after 2 cycles.
The driver passed \texttt{rand} to \texttt{drive\_dut} after a cycle.
When \texttt{f\_bitclr} is \texttt{f000}, the top 4 bits of the output are set to 0, and when \texttt{f\_bitset} is \texttt{0004}, bit 2 of the output is set to 1.
It should be noted, that if the same bit is set and cleared by the user, \texttt{f\_bitclr} takes priority.
This is an arbitrary choice, and is noted in the user guide.

The driver delays the output to monitor by 2 cycles, and we can see that this aligns it the output from the DUT.

\section{Monitor}
\begin{figure}[H]
  \centering
  \input{illu/monitor_block}
  \caption{Monitor Block Diagram}
  \label{MonitorBlk}
\end{figure}

The monitor takes DUT inputs from the driver, and distributes them to a few sub-monitors.
Each sub-monitor containing a reference design then produces the correct results \texttt{mon\_out} from the inputs with a relaxed time budget.
The monitor then checks the difference between the reference output, \texttt{mon\_out}, and the DUT output, \texttt{dut\_out} with XOR gates.
This results in \texttt{diff}, where each bit set to 1 indicates a wrong bit in the DUT output.

As the number of sub-monitors and the width of the tested unit are parametrised, the design of the distributor was not straightforward.
A one-hot counter is set up to determined the currently active sub-monitor.
A 2D register array of size \texttt{WIDTH} $\times$ \texttt{NUM\_SUB\_MON} is also created for each input or output of the design.
These serves as the interface between the sub-monitors and the rest of the design, since the sub-monitors are clocked \texttt{NUM\_SUB\_MON} times slower.


\subsection{Sub-monitors}

\begin{figure}[H]
  \centering
  \input{illu/submonitor_block}
  \caption{Sub-monitor Block Diagram}
  \label{SubmonBlk}
\end{figure}

The current sub-monitor is an imperfect implementation of the reference module in the architecture design.


\begin{figure}[H]
  \centering
  \input{illu/monitor_wave}
  \caption{Monitor Waveform}
  \label{MonitorWave}
\end{figure}

\section{Scoreboard}

\begin{figure}[H]
  \centering
  \input{illu/scoreboard_block}
  \caption{Scoreboard Block Diagram}
  \label{ScoreboardBlk}
\end{figure}

\begin{figure}[H]
  \centering
  \input{illu/scoreboard_wave}
  \caption{Scoreboard Waveform}
  \label{ScoreboardWave}
\end{figure}
